<html>
<head>

[ZONE WEBDESK:HEAD]

<script src="WHAT/Layout/DHTMLapi.js"></script>
<script src="WHAT/Layout/AnchorPosition.js"></script>
<script src="WHAT/Layout/geometry.js"></script>

[JS:REF]

<script>
    [JS:CODE]

var colCount = [colCount];
var colContent = new Array;
var services = new Array();

function initPortal() {

  resizeCols();

  [BLOCK USvc]
  services[services.length] = { snum:[snum], sid:[sid], stitle:'[stitle]', 
				vurl:'[vurl]', eurl:'[eurl]', purl:'[purl]',
				rdel:[rdel], nextLoad:0, col:[col], lin:[lin], 
				i:[interactif], m:[mandatory], e:[editable], d:false }; [ENDBLOCK USvc]
									 
  displayServices();

  setTimeout("startRefresh()", 60*1000);
}

function startRefresh() {
  var  sl = '';
  var dat = new Date();
  var mdat = dat.getTime();
  sl = '('+mdat+') ';
  for (var is=0; is<services.length; is++) {
    sl += '\n'+services[is].title+'('+services[is].rdel+')'+':'+services[is].nextLoad+' > ';
    if (services[is].rdel>0 && services[is].nextLoad>0 && services[is].nextLoad<=mdat) {
      services[is].nextLoad == 0;
      loadSvcAsync(services[is].snum, true);
      sl += 'reload';
    } else {
      sl += 'no';
    } 
  }
//   alert('a reloader : '+sl);
  setTimeout("startRefresh()", 60*1000);
}  

function startUtempo() {
  globalcursor('progress');
}

function endUtempo() {
  unglobalcursor();
}

function resizeCols() {
  var icol = 0;
  var bodW = getFrameWidth();
  var colW = parseInt(bodW/colCount);
  for (icol=0; icol<colCount; icol++) {
    document.getElementById('wdcol'+icol).style.width = colW-1;
    document.getElementById('wdcol'+icol).style.display = 'block';
  }
}

function addNewService(sid) {
  startUtempo(); 
  var xreq = null;
  if (window.XMLHttpRequest) xreq = new XMLHttpRequest();
  else xreq = new ActiveXObject("Microsoft.XMLHTTP");
  if (xreq) {
    xreq.open("POST", "[CORE_STANDURL]app=WEBDESK&action=ADDSERVICE&sid="+sid, false);
    xreq.send('');
    if (xreq.status!=200) {
      alert('[TEXT:wd error add service] (HTTP Code '+xreq.status+')');	   
    } else { 
      eval(xreq.responseText);
      if (svcnum && svcnum>-1) {
	xreq.open("POST", "[CORE_STANDURL]app=WEBDESK&action=GETJSSERVICE&snum="+svcnum, false);
	xreq.send('');
	if (xreq.status!=200) {
	  alert('[TEXT:wd error getting service] (HTTP Code '+xreq.status+')');	   
	} else { 
	  eval(xreq.responseText);
	  services[services.length] = svc;
	  displayServices();
	}
      } else {
	alert('[TEXT:wd invalid service number returned by creation]');	   
      }
    }
  } else {
    alert('[TEXT:wd error add service] (XMLHttpRequest contruction)');	   
  }
  endUtempo();
}


function displayServices() {
  for (var is=0; is<services.length; is++) {
    if (services[is].d===false) {
      showService(is);
    }
  }
}


function showService(is) {

  var snum = services[is].snum;
  if (document.getElementById('svc'+snum)) return; // Service already displayed

  var stitle = services[is].stitle;
  var vurl   = services[is].vurl;
  var eurl   = services[is].eurl;
  var iseditable   = services[is].e;
  var ismandatory  = services[is].m;
  var isinteractive  = services[is].i;
  var line  = services[is].line;
  var col  = services[is].col;
  
  var root = document.getElementById('wdcol'+col);
  if (root) {

    var svc = document.createElement('div');
    svc.id = 'svc'+snum;
    svc.name = 'svc'+snum;
    svc.className = 'wdsvc';
    root.appendChild(svc);

      
      
    var tsvc = document.createElement('div');
    tsvc.id = 'tsvc'+snum;
    tsvc.name = 'tsvc'+snum;
    
    var cnt = '';
    cnt += '<table width="100%" cellspacing="0" cellpadding="0" style="border:0px"><tr><td><span id="tsvcti'+snum+'">'+stitle+'</span></td>';
 
    cnt += '<td style="text-align:right">';

    if (col>0) cnt += '<img class="small_button" onclick="moveSvc('+snum+',-1,0)" src="[IMG:wd_go_left.gif]" title="[TEXT:wd go left]">';
    if (col<colCount) cnt += '<img class="small_button" onclick="moveSvc('+snum+',0,1)" src="[IMG:wd_go_down.gif]" title="[TEXT:wd go down]">';
    if (line>0) cnt += '<img class="small_button" onclick="moveSvc('+snum+',0,-1)" src="[IMG:wd_go_up.gif]" title="[TEXT:wd go up]">';
    cnt += '<img class="small_button" onclick="moveSvc('+snum+',1,0)" src="[IMG:wd_go_right.gif]" title="[TEXT:wd go right]">';
    cnt += '&nbsp;';
    
    cnt += '<img id="ivsvc'+snum+'" style="margin-left:2px" class="small_button" onclick="showHideSvc('+snum+');" src="[IMG:wd_svc_hide.gif]" title="[TEXT:wd hide svc content]">';
    if (vurl!='')
      cnt += '<img id="irsvc'+snum+'" style="margin-left:2px" class="small_button" onclick="startUtempo(); loadSvcAsync('+snum+', true);endUtempo(); " src="[IMG:wd_svc_reload.gif]" title="[TEXT:wd reload svc content]">';
    if (eurl!='' && iseditable)
      cnt += '<img id="iesvc'+snum+'" style="margin-left:2px" class="small_button" onclick="editSvc('+snum+');" src="[IMG:wd_svc_edit.gif]" title="[TEXT:wd edit svc content]">';
    if (!ismandatory)
      cnt += '<img id="iesvc'+snum+'" style="margin-left:2px" class="small_button" onclick="deleteSvc('+snum+');" src="[IMG:wd_svc_delete.gif]" title="[TEXT:wd delete svc]">';
    cnt += '</td></tr></table>';
    tsvc.innerHTML = cnt;
    tsvc.className = 'wdsvc_title';

    svc.appendChild(tsvc);

    var csvc = document.createElement('div');
    csvc.setAttribute('id','csvc'+snum);
    csvc.name = 'csvc'+snum;
    if (vurl=='') {
      csvc.innerHTML = '[TEXT:wd url for retrieving information not given]';
      csvc.className = 'wdsvc_content wdsvc_warning';
    } else {
      csvc.className = 'wdsvc_content';
    }
    csvc.style.overflow = 'auto';

    if (isinteractive) {
      var fsvc = document.createElement('form');
      fsvc.id = 'fsvc'+snum;
      fsvc.name = 'fsvc'+snum;
      fsvc.method = 'POST';
      fsvc.action = vurl;
      fsvc.serviceId = snum;
      fsvc.onsubmit = 'submitService(this.form); return false;';
      svc.appendChild(fsvc);
      fsvc.appendChild(csvc);
    } else {
      svc.appendChild(csvc);
    }

    
    loadSvcAsync(snum);
  }
}

function submitService(eltform) {
  var snum = eltform.serviceId;
  var is = getSvc(snum);
  if (is===false) return false; 

  var params = ''
  var fsend = document.getElementById('fsvc'+snum);
  for (var ie=0; ie<fsend.elements.length; ie++) {
    if (fsend.elements[ie].name!="") params += '&'+fsend.elements[ie].name+'='+fsend.elements[ie].value;
  }

  loadSvcAsync(snum, true, params);
  eltform.reset();
  return false;
}

function getSvc(snum) {
  for (var ix=0; ix<services.length; ix++) {
    if (services[ix].snum == snum) return ix;
  }
  return false;
}

var ereq = null;
var editSnum = -1;
function editSvc(snum) {

  var is = getSvc(snum);
  if (is===false) return;

  if (services[is].eurl=='') {
    document.getElementById('editsvc_c').innerHTML = '[TEXT:edition url not given]';
    return;
  }

  // initialize form
  editSnum = snum;

  var esvc = document.getElementById('editsvc').cloneNode(true);
  esvc.id = 'editsvc'+snum;
  esvc.style.top = esvc.style.left = 0; 
  esvc.style.display = 'block';
  document.getElementById('csvc'+snum).appendChild(esvc);
  document.getElementById('editsvc_c').innerHTML = '[TEXT:wd loading edition forms]';
  if (services[is].eurl!='') {
    if (window.XMLHttpRequest) ereq = new XMLHttpRequest();
    else ereq = new ActiveXObject("Microsoft.XMLHTTP");
    if (ereq) {
      ereq.open("POST", services[is].eurl, false);
      ereq.send('');
      if (ereq.status!=200) {
	document.getElementById('editsvc_c').innerHTML = '[TEXT:wd error retrieving edit form] (HTTP Code '+ereq.status+')';	   
      } else { 
 	document.getElementById('editsvc_c').innerHTML = '<div>'+ereq.responseText+'</div>';
	if (services[is].purl!='') {
	  var tpurl = services[is].purl.split('&');
	  var fedit = document.getElementById('editsvcf');
	  for (var ie=0; ie<fedit.elements.length; ie++) {
	    for (var ip=0; ip<tpurl.length; ip++) {
	      if (tpurl[ip]!='') {
		var thisp = tpurl[ip].split('=');
		if (fedit.elements[ie].name==thisp[0]) {
		  fedit.elements[ie].value = thisp[1];
		}
	      }
	    }
	  }
	}
      }
    } else {
      document.getElementById('editsvc_c').innerHTML = '[TEXT:wd error retrieving edit form] (XMLHttpRequest contruction)';	    
    }
  }
}

function sendForm() {
  var fedit = document.getElementById('editsvcf');
  if (editSnum===-1) return;
  var snum = editSnum;

  var is = getSvc(snum);
  if (is===false) return;

  var purl = '';
  for (var ie=0; ie<fedit.elements.length; ie++) {
    purl += '&'+fedit.elements[ie].name+'='+fedit.elements[ie].value;
  }
  if (window.XMLHttpRequest) ereq = new XMLHttpRequest();
  else ereq = new ActiveXObject("Microsoft.XMLHTTP");
  if (ereq) {
    ereq.open("POST", encodeURI("[CORE_STANDURL]&app=WEBDESK&action=SAVESVC&snum="+editSnum+"&params="+escape(purl)), false);
    ereq.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    ereq.send('');
    if (ereq.status!=200) {
      document.getElementById('csvc'+snum).innerHTML = '[TEXT:wd error saving edit form] (HTTP Code '+ereq.status+')';	   
    } else { 
      services[is].purl = purl;
      loadSvcAsync(snum);
    }
  } else {
    document.getElementById('csvc'+snum).innerHTML = '[TEXT:wd error saving edit form] (XMLHttpRequest contruction)';	    
  }
  editSnum = -1;
}

function showHideSvc(sid) {
  var is = getSvc(sid);
  if (is===false) return;
  if (document.getElementById('csvc'+sid)) {
    if (services[is].display) {
      document.getElementById('csvc'+sid).style.display = 'none';
      document.getElementById('ivsvc'+sid).src = '[IMG:wd_svc_show.gif]';
      document.getElementById('ivsvc'+sid).title = '[TEXT:wd show svc content]';
      services[is].display = false;
    } else {
      document.getElementById('csvc'+sid).style.display = 'block';
      document.getElementById('ivsvc'+sid).src = '[IMG:wd_svc_hide.gif]';
      document.getElementById('ivsvc'+sid).title = '[TEXT:wd hide svc content]';
      services[is].display = true;
    }
  }
}


function moveSvc(snum,c,l) {
  var is = getSvc(snum);
  if (is===false) return;
  services[is].col = services[is].col + c;
  services[is].lin = services[is].lin + l;
  unDisplaySvc(snum);
  showService(is);
  var xreq = null;
  if (window.XMLHttpRequest) xreq = new XMLHttpRequest();
  else xreq = new ActiveXObject("Microsoft.XMLHTTP");
  if (xreq) {
    xreq.open("POST", "[CORE_STANDURL]app=WEBDESK&action=GEOSERVICE&spec="+services[is].snum+":"+services[is].col+":"+services[is].lin, false);
    xreq.send('');
    if (xreq.status!=200) alert('[TEXT:wd error geo service] (HTTP Code '+xreq.status+')');	   
  } else {
    alert('[TEXT:wd error geo service] (XMLHttpRequest contruction)');	   
  }
  
}
  

function unDisplaySvc(snum) {
  var is = getSvc(snum);
  if (is===false) return;
  if (document.getElementById('svc'+snum)) {
    var svc = document.getElementById('svc'+snum);
    svc.parentNode.removeChild(svc);
    services[is].display = false;

  }
}


function deleteSvc(snum) {
  var is = getSvc(snum);
  if (is===false) return;
  if (!confirm('[TEXT:wd confirm supress of] '+services[is].stitle)) return false;
  unDisplaySvc(snum);
  services.splice(is,1);
  var xreq = null;
  if (window.XMLHttpRequest) xreq = new XMLHttpRequest();
  else xreq = new ActiveXObject("Microsoft.XMLHTTP");
  if (xreq) {
    xreq.open("POST", "[CORE_STANDURL]app=WEBDESK&action=DELSERVICE&snum="+snum, false);
    xreq.send('');
    if (xreq.status!=200) alert('[TEXT:wd error add service] (HTTP Code '+xreq.status+')');	   
  } else {
    alert('[TEXT:wd error add service] (XMLHttpRequest contruction)');	   
  }
}

function setWS(sid) {
  var value = 40;
  if (document.getElementById('svc'+sid)) {
    var o = document.getElementById('svc'+sid);
    o.style.opacity = value/100;
    o.style.filter = 'alpha(opacity=' + value + ')';
  }
}
function unsetWS(sid) {
  var value = 100;
  if (document.getElementById('svc'+sid)) {
    var o = document.getElementById('svc'+sid);
    o.style.opacity = value/100;
    o.style.filter = 'alpha(opacity=' + value + ')';
  }
}


function loadSvc(sid, shl, params) {
  var dreq = null;
  var is = getSvc(sid);
  if (is===false) return;

  if (services[is].vurl=='') return;

  if (shl) setWS(sid);

  if (window.XMLHttpRequest) dreq = new XMLHttpRequest();
  else dreq = new ActiveXObject("Microsoft.XMLHTTP");
  if (dreq) {
    dreq.open("POST", services[is].vurl+services[is].purl, false);
    dreq.send('');
    if (dreq.status!=200) {
      document.getElementById('csvc'+sid).innerHTML = '[TEXT:wd error retrieving content] (HTTP Code '+dreq.status+')';	   
    } else { 
      document.getElementById('csvc'+sid).innerHTML = '<div>'+dreq.responseText+'</div>';
    }
  } else {
    document.getElementById('csvc'+sid).innerHTML = '[TEXT:wd error retrieving content] (XMLHttpRequest contruction)';	    
  }
  if (shl) unsetWS(sid);
}

var timerOn = new Array();
function loadSvcAsync(sid, shl, params) {
  var dreq = null;
  var is = getSvc(sid);
  if (is===false) return;

  if (services[is].vurl=='') return;

  if (window.XMLHttpRequest) dreq = new XMLHttpRequest();
  else dreq = new ActiveXObject("Microsoft.XMLHTTP");
  if (dreq) {
    if (shl) setWS(sid);
    dreq.onreadystatechange =  function() {
      if (dreq.readyState == 4) {
	if (dreq.status!=200) {
	  document.getElementById('csvc'+sid).innerHTML = '[TEXT:wd error retrieving content] (HTTP Code '+dreq.status+')';	   
	} else { 
	  document.getElementById('csvc'+sid).innerHTML = '<div>'+dreq.responseText+'</div>';
	  if (services[is].rdel>0) {
	    var dat = new Date();
	    services[is].nextLoad = dat.getTime() + (services[is].rdel*60*1000);
// 	    alert('date : '+dat.getTime() +' prochain lancement : '+services[is].nextLoad);
	  } else {
	    timerOn[is] = -1;
	  }	    
	}
	if (shl) unsetWS(sid);
      }
    }
    var url = services[is].vurl+services[is].purl;
    if (params) url += params;
    dreq.open("POST", url, true);
    dreq.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    dreq.send('');
  } else {
    document.getElementById('csvc'+sid).innerHTML = '[TEXT:wd error retrieving content] (XMLHttpRequest contruction)';	    
  }
}

// Params 
var paramIsOpen = false;
function opencloseParams() {
  if (document.getElementById('wdparamset')) {
    var dp = document.getElementById('wdparamset');
    var dpi = document.getElementById('wdparamimg');
    if (paramIsOpen) {
      if (dpi) dpi.src = "[IMG:wd_open_services.gif]";
      dp.style.display = 'none';
      paramIsOpen = false;
    } else {
      if (dpi) dpi.src = "[IMG:wd_close_services.gif]";
      dp.style.display = 'block';
      paramIsOpen = true;
   }
  }
}
    


</script>
<style type="text/css">

[ZONE WEBDESK:CSS]


[CSS:CODE]</style>
</head>
<body onload="initPortal()" onresize="resizeCols()">
[BLOCK cols]
<div id="wdcol[icol]" class="wdcols" style="display:none; float:left;">
[IF firstCol]<div class="wdtitleb" style="margin:5px; text-align:left; vertical-align:middle">[TEXT:wd manage portal]
<img class="small_button" id="wdparamimg" onclick="opencloseParams()" src="[IMG:wd_open_services.gif]" title="[TEXT:wd show/hide service list]">
<img class="small_button" onclick="document.location.reload(false)" src="[IMG:wd_portal_reload.gif]" title="[TEXT:wd reload portal view]">
</div>[ENDIF firstCol]
</div>[ENDBLOCK cols]

<div id="editsvc" style="padding:5px; margin:5px; border:1px solid #CFCFCF; display:none; position:relative">
<form name="editsvcf" id="editsvcf" method="POST" action="[CORE_STANDURL]&app=WEBDESK&action=SVCSAVE">
<div id="editsvc_c"></div>
<div class="wdbuttonb"><img class="small_button" onclick="sendForm()" src="[IMG:wd_save.gif]" title="[TEXT:wd save]"></div>
</form>
</div>

<div id="wdparamset" class="wdparamb" style="position:absolute; left:20px; top:20px; display:none" >
<div class="wdtitleb" >[TEXT:wd available services]</div>
[BLOCK catS]<div class="wdtitleb1" >[categorie]</div>
[BLOCK services[categorie]]<div title="[psvc_descr]">[IF Icon]<img style="height:16px" class="small_button" title="[psvc_title]" src="[CORE_BASEURL]app=FDL&action=EXPORTFILE&vid=[vid]&docid=[docid]&attrid=[attrid]&index=-1">[ENDIF Icon][IFNOT Icon]&nbsp;&rarr;[ENDIF Icon]&nbsp;[psvc_title]&nbsp<img class="small_button" onclick="addNewService([id]); opencloseParams()" title="[TEXT:wd add service] [psvc_title]" src="[IMG:wd_add_service.gif]"></div>[ENDBLOCK services[categorie]][ENDBLOCK catS]
<div class="wdbuttonb" style="text-align:right"><img class="small_button" onclick="opencloseParams()" src="[IMG:wd_cancel.gif]" title="[TEXT:wd close]"></div>
</div>

</body>
</html>
